---
import GetEstimateBtn from '../components/GetEstimateBtn.astro';
import RedLine from '../components/RedLine.astro';
import {atFormSend} from '../scripts/form'

if (Astro.request.method === "POST") {
  try {
    const data = await Astro.request.formData();
    const name = data.get("username");
    const email = data.get("email");
    const password = data.get("password");
    // Do something with the data
  } catch (error) {
    if (error instanceof Error) {
      console.error(error.message);
    }
  }
}
---
<script>
    import {atFormSend} from '../scripts/form'
    function atStepNext(steps, active) {
        const next = (active + 1) % steps.length
        steps[active].element.classList.remove('at-step-active')
        steps[next].element.classList.add('at-step-active')
        return {active: next, submit: next === steps.length - 1}
    }

    document.querySelectorAll('.at-steps').forEach(root => {
        const form = root.closest('form')
        const nextBtn = root.querySelector('button')
        const steps = [...root.querySelectorAll('.at-step')].map((element, index) => ({element, index}))
        let active = 0
        if (nextBtn == null) {
            return
        }
        nextBtn.addEventListener('click', () => {
            const invalid = [...steps[active].element.querySelectorAll(':invalid')]
            if (invalid.length === 0) {
                const action = atStepNext(steps, active)
                active = action.active
                if (action.submit) {
                    atFormSend(form, 'https://eos.ct1.xyz/quad-at-form.php').then(res => {
                        console.log(res)
                    }).catch(err => {
                        console.log(err)
                    })
                }
            }
        })
    })
</script>

<div class="flex flex-col items-start justify-center items-center pb-4 pt-12">
    <p class="v-copy2">get estimate</p>
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-red mt-4">
        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25 12 21m0 0-3.75-3.75M12 21V3" />
    </svg>
</div>
<div class="card rounded-lg mx-auto text-center w-full lg:w-1/2 p-1 mb-12 shadow-est">
    <div class="at-bg">
        <h2 class="font-bold text-xs text-gray md:text-lg uppercase text-gray pt-12 ">send tarmac estimate in under 30 seconds!</h2>
        <h1 class="text-xl font-black md:text-3xl text-white">Rapid Tarmac Estimate</h1>
        <form name="estimate" method="POST" autocomplete="off">
            <div class="pt-12 at-steps">
                <nav>
                    <span>1</span><hr /><span>2</span><hr /><span>3</span>
                    <!--  <img src="/estimate-numbers.svg" alt="3 steps tarmac estimate process"/> -->
                </nav>
                <div class="at-step at-step-active">
                    <div class="pt-12">
                        <select class="w-72 h-12 border border-gray bg-gray-dark rounded-xl p-4 text-base text-gray font-bold text-xl" name="client" required>
                            <option value="Domestic">Domestic</option>
                            <option value="Commercial">Commercial</option>
                            <option value="Public Sector">Public Sector</option>
                        </select>
                    </div>
                </div>
                <div class="at-step">
                    <div class="pt-12">
                        <label>
                            <input class="w-72 h-12 border border-gray bg-gray-dark rounded-xl p-4 text-base text-gray font-bold text-xl" type="text" name="name" placeholder="Name" required />
                        </label>
                    </div>
                    <div class="pt-12">
                        <label>
                            <input class="w-72 h-12 border border-gray bg-gray-dark rounded-xl p-4 text-base text-gray font-bold text-xl" type="tel" name="tel" placeholder="Telephone" required />
                        </label>
                    </div>
                    <div class="pt-12">
                        <label>
                            <input class="w-72 h-12 border border-gray bg-gray-dark rounded-xl p-4 text-base text-gray font-bold text-xl" type="email" name="email" placeholder="E-mail address" required />
                        </label>
                    </div>
                </div>
                <div class="at-step">
                    <div class="pt-12">
                        <label>
                            <textarea class="w-72 h-36 border border-gray bg-gray-dark rounded-xl p-4 text-base text-gray font-bold text-xl" name="notes" required placeholder="Notes"></textarea>
                        </label>
                    </div>
                    <div class="pt-12">
                        <label>
                            <input class="w-72 h-12 border border-gray bg-gray-dark rounded-xl p-4 text-base text-gray font-bold text-xl" type="file" name="attachment" />
                        </label>
                    </div>
                </div>
                <div class="at-step">
                    <div class="pt-12">
                        <p>Calculating estimate&hellip;</p>
                    </div>
                </div>
                <div class="flex justify-center">
                    <GetEstimateBtn/>
                </div>
            </div>
        </form>
    </div>
    <div class="blob"></div>
</div>
